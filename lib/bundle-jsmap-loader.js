!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("jsmap",[],e):"object"==typeof exports?exports.jsmap=e():t.jsmap=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t){var e=t.size(),n=e.width,r=e.height,o=new Uint8Array(n*r);return t.points().forEach(function(t){for(var e=t.x+t.y*n,r=t.n,i=t.v;r>0;)o[e++]=i,r--}),o}function o(t){void 0===t&&(t={});var e=t.model||"silam/glob",n=t.specie||"pm25";return new s(function(o,s){var u=a.Loader.create(null,null),c={standard:"usepa",model:e,pol:n};u.init(c).then(function(e){var n=t.fps?1e3/t.fps:0,a={frames:n?i.DelayedPubSub.createWithDelay(n):i.PubSub.create(),bounds:e.getLatLngBounds(),size:e.getPixelSize(),timespan:e.getTimeSpan(),nframes:e.getTotalFrameCount(),lut:{colors:e.getStream().colors.lut.html,vcolors:e.getStream().colors.lut.hex,aqi:e.getEncodingStandard().lut}};o(a);var s=0,u={};e.onFrameLoaded.subscribe(function(t){var e=(new Date).getTime(),n={idx:t.idx(),datetime:t.datetime,matrix:r(t)};(new Date).getTime()-e;for(n.idx==s?(a.frames.publish(n),s++):u[n.idx]=n;u[s];)n=u[s],a.frames.publish(n),u[s]=void 0,s++})})["catch"](function(t){s(t)})})}var i=n(1),a=n(2),s=n(8);e.load=o},function(t,e){"use strict";var n=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},r=function(){function t(t){this.subscribers=[],this.differedEvents=[],this.differ=t}return t.create=function(){return new t(!1)},t.createDiffered=function(){return new t(!0)},t.prototype.subscribe=function(t){var e=this;this.subscribers.push(t),this.differ&&(this.differedEvents.forEach(function(t){e.subscribers.forEach(function(e){return e(t)})}),this.differedEvents=[],this.differ=!1)},t.prototype.publish=function(t){void 0===t&&(t=void 0),this.differ?this.differedEvents.push(t):this.subscribers.forEach(function(e){return e(t)})},t}();e.PubSub=r;var o=function(t){function e(e){t.call(this,e),this.firstPublishedTime=0,this.period=20,this.queue=[],this.lastPublishedTime=(new Date).getTime()}return n(e,t),e.createWithDelay=function(t){var n=new e(!0);return n.period=t,n},e.prototype.publish=function(t){var e=this,n=(new Date).getTime();0==this.firstPublishedTime&&(this.firstPublishedTime=n);var r=this.period-(n-this.lastPublishedTime);this.queue.push(t),1==this.queue.length&&setTimeout(function(){return e.dequeue()},r)},e.prototype.dequeue=function(){var e=this,n=this.queue.shift();t.prototype.publish.call(this,n),this.queue.length>0&&setTimeout(function(){e.dequeue()},this.period)},e}(r);e.DelayedPubSub=o},function(module,exports,__webpack_require__){"use strict";function lfetch(url){return"undefined"!=typeof fetch?fetch(url).then(function(t){return t.json()}):new Promise(function(resolve,reject){var r=new XMLHttpRequest;r.open("GET",url,!0),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var sjson=r.responseText;if(null==sjson||0==sjson.length)return resolve(null);var json,s="("+sjson+")";try{json=eval(s)}catch(e){return void reject("Invalid JSON while loading "+url)}resolve(json)}},r.send("")})}var framestream_1=__webpack_require__(3),frame_1=__webpack_require__(6),pubsub_1=__webpack_require__(1),utils_1=__webpack_require__(5),Promise=__webpack_require__(8),server="https://wind.waqi.info/forecast/aqi/",Loader=function(){function t(t,e){this.divs=t,this.configs=[],this.map=e}return t.create=function(e,n){return new t(e,n)},t.prototype.selectModel=function(t){var e=this;return this.divs&&this.divs.loader.style("display","block"),new Promise(function(n,r){var o=server+t.model+"/best/"+t.pol+"/";e.configs[o]?(t.data=e.configs[o],e.ctrl.reinit(t),n(e.ctrl)):lfetch(o+"conf.json").then(function(i){i?(e.configs[o]=i,t.data=i,e.ctrl.reinit(t),n(e.ctrl)):r("no model!")},r)})},t.prototype.init=function(t){var e=this;this.conf=t;var n=server+t.model+"/best/"+t.pol+"/";t.model+" - "+t.pol;return new Promise(function(r,o){e.divs&&e.divs.loader.style("display","block"),lfetch(n+"conf.json").then(function(o){o&&(e.configs[n]=o,t.data=o,e.ctrl=new LoaderCtrlImpl(t,e.divs,e.map),r(e.ctrl))})["catch"](function(t){var e="Sorry, something wrong happen while loading the configuration";o(e+" (e:"+t.toString()+")")})})},t}();exports.Loader=Loader;var LoaderCtrlImpl=function(){function t(t,e,n){this.onFrameLoaded=pubsub_1.PubSub.create(),this.onError=pubsub_1.PubSub.create(),this.onStep=pubsub_1.PubSub.create(),this.bounds=t.data.bounds,this.divs=e,this.frameCache=[],this.map=n,this.reinit(t)}return t.prototype.reinit=function(t){if(this.path=server+t.model+"/best/"+t.pol+"/",this.modelId=t.model,this.polId=t.pol,this.step=0,this.framesLoaded=[],"mpim/china"==t.model)throw"Something wrong happened while loading the model";if(!t.data.standard[t.standard])return utils_1.log("Unknown standard...",t),!1;var e=t.data.standard[t.standard].jsmap,n=[];if(e.files)for(var r in e.files)n.push({file:e.files[r],hour:r});else for(var r in e){var o=e[r];n.push({file:o,hour:r})}n.sort(function(t,e){return t.hour-e.hour});var i=e.encoding||{};i.polutant=t.pol,i.standard=t.standard,this.encodingStandard=i,this.hasStream=t.data.version>=3,this.framesToLoad=n,this.count=n.length;var a=(n.length,[]),s=[];for(var u in t.data.datetimes)s.push(t.data.datetimes[u]),a.push(new Date(t.data.datetimes[u]));return this.timeSpan={min:a[0],max:a[a.length-1],values:a,svalues:s},this.frameSize={width:1*t.data.size[0],height:1*t.data.size[1]},this.stream=framestream_1.FrameStream.create(this.getPixelSize(),this.getLatLngBounds(),this.encodingStandard),this.loadFrames(),!0},t.prototype.render=function(t){this.isAvailable()&&(t.draw(this.current()),this.onStep.publish(this.step))},t.prototype.getTimeSpan=function(){return this.timeSpan},t.prototype.getEncodingStandard=function(){return this.encodingStandard},t.prototype.getTotalFrameCount=function(){return this.framesToLoad.length},t.prototype.streamFrames=function(){function t(t,e){this.divs&&this.divs.loader.style("display","none");var n=t.indexOf(":"),r=t.substr(0,n).split("/");t=t.substr(n+1),t.length!=r[1]&&utils_1.log("Wrong frame size? "+t.lenght+"!="+r[1]);var o={idx:e,data:t,datetime:this.timeSpan.values[e],sdate:this.timeSpan.svalues[e]},i=new frame_1.Frame(o,this.stream);this.framesLoaded[e]=i,this.onFrameLoaded.publish(i)}var e=this,n=this,r=function(){function e(){this.acc="",this.count=0}return e.prototype.push=function(e){var r=e.split("\n");this.acc+=r[0];for(var o=1;o<r.length;o++)this.acc.length>0&&"#"!=this.acc[0]&&(t.apply(n,[this.acc,this.count]),this.count++),this.acc=r[o]},e}(),o=new r,i=this.path+"jsmap/stream.jsmap";fetch(i).then(function(t){var e=t.body.getReader(),n=new TextDecoder,r=function(){return e.read().then(function(t){if(t.value){var e=n.decode(t.value,{stream:!t.done});o.push(e)}t.done||r()})};return r()})["catch"](function(t){return e.onError.publish(t)})},t.prototype.loadFrames=function(){var t=this;return this.hasStream&&"undefined"!=typeof TextDecoder?this.streamFrames():void this.framesToLoad.forEach(function(e,n){setTimeout(function(){var r=t.path+e.file;t.frameCache[r]?(t.divs&&t.divs.loader.style("display","none"),t.framesLoaded[n]=t.frameCache[r]):lfetch(r).then(function(e){if(t.divs&&t.divs.loader.style("display","none"),!e.status||"error"!=e.status){var o=e;o.idx=n,o.sdate=e.datetime,o.datetime=new Date(e.datetime);var i=new frame_1.Frame(o,t.stream);t.frameCache[r]=i,t.framesLoaded[n]=i,t.onFrameLoaded.publish(i)}},function(e){return t.onError.publish(e)})},20*(n-10))})},t.prototype.getStream=function(){return this.stream},t.prototype.getPixelSize=function(){return this.frameSize},t.prototype.getLatLngBounds=function(){var t=this.getBounds();return{topLeft:{lat:t[0][0],lng:t[0][1]},bottomRight:{lat:t[1][0],lng:t[1][1]}}},t.prototype.getBounds=function(){var t=this.bounds,e=t[0][1],n=t[1][1];return e>n&&(e-=360),t[0][1]=e,t},t.prototype.progress=function(){var t=this.framesLoaded[this.step];if(t){var e=(this.step+1)/this.count,n=moment(t.datetime).utc().format("dddd, MMMM Do, H:mm");return{p:e,time:n,datetime:t.datetime}}},t.prototype.isAvailable=function(){var t=!!this.framesLoaded[this.step];return t},t.prototype.current=function(){var t=this.framesLoaded[this.step];return t},t.prototype["goto"]=function(t){this.step=t,this.step<0&&(this.step=0),this.step>=this.count&&(this.step=this.count-1)},t.prototype.backward=function(){this.step--,this.step<0&&(this.step=this.count-1)},t.prototype.forward=function(){return this.step++,this.step>=this.count?(this.step=0,!0):!1},t}()},function(t,e,n){"use strict";var r=n(4),o=function(){function t(){}return t.create=function(e,n,o){var i=new t;return i.bounds=n,i.size=e,i.colors=r.getColors(o),i},t}();e.FrameStream=o},function(t,e,n){"use strict";function r(t,e,n,r){return"#"+("0"+parseInt(t,10).toString(16)).slice(-2)+("0"+parseInt(e,10).toString(16)).slice(-2)+("0"+parseInt(n,10).toString(16)).slice(-2)}function o(t,e){var n=e.map(function(t){t=t.substr(1),6==t.length&&(t="ff"+t);var e=parseInt(t.substr(0,2),16),n=parseInt(t.substr(2,2),16),o=parseInt(t.substr(4,2),16),i=parseInt(t.substr(6,2),16),a=(255&e)<<24|(255&n)<<16|(255&o)<<8|255&i;return{r:n,g:o,b:i,a:e,color:r(n,o,i,e),hex:a}}),o=t.length,i=t[o-1],a=t[0];return function(e){if(a>=e)return{html:n[0].color,hex:n[0].hex};if(e>=i)return{html:n[o-1].color,hex:n[o-1].hex};for(var s=1;o>s;s++)if(e<t[s]){var u=1-(e-t[s-1])/(t[s]-t[s-1]),c=Math.round(n[s-1].a*u+n[s].a*(1-u)),l=Math.round(n[s-1].r*u+n[s].r*(1-u)),f=Math.round(n[s-1].g*u+n[s].g*(1-u)),d=Math.round(n[s-1].b*u+n[s].b*(1-u)),h=(255&c)<<24|(255&l)<<16|(255&f)<<8|255&d;return{html:r(l,f,d,c),hex:h}}}}function i(t){var e=null,n=null,r=null,i=0,u=t.polutant;if("usepa"==t.standard)if("aotk"==u||"humidity"==u||s[u]){var c=t.range.reduce(function(t,e){return t+e},0),l=["#00ffffff","#6b00f9","#3236ff","#0c7df7","#00bae0","#12e5bd","#3cfc8e","#76fc58","#b2e51c","#e3ba00","#fd7d00","#fa3600","#db0000","#a70000","#000000"],f=l.map(function(t,e){return e*c/(l.length-1)});e=o(f,l),n=[0,c],i=1}else if("no2"==u||"so2"==u||"co"==u){var d=["#ffffff","#6b00f9","#00bae0","#b2e51c","#fa3600","#a70000"];n=[0,16],e=o([0,2,4,8,12,16],d),i=1}else{var d=["#ffffff","#009966","#ffde33","#ff9933","#cc0033","#660099","#7e0023","#7e0023","#000000"];e=o([0,2,4,6,8,10,12,14,16],d),n=[0,16],i=2}else{if("eucaqi"!=t.standard)throw a.log("Unknown config....",t),"Unknown configuration!";var d=["#ffffff","#5ec569","#b2d744","#f2c500","#fe8d00","#fa0067"];e=o([0,2,4,6,8,10,12,14,16],d),n=[0,16],i="o3"==u?4:1}for(var h=function(e){try{return Math.round(t.lut[e])}catch(n){}return e+1},p=[],m=[],v=[],b=[],g=n[0];g<=n[1];g++){var y=e(g);b[g]=r?r(g):(y.hex>>24&255)/255,m[g]=y.html,v[g]=y.hex,p.push({col:y.html,lvl:h(g)})}return r||(b=void 0),{lut:{hex:v,html:m,alpha:b},palette:p,minlvl:i}}var a=n(5),s={"total-cloud-cover":[{col:"#00bae0",lvl:50,a:.5},{col:"#3cfc8e",lvl:60,a:.5},{col:"#b2e51c",lvl:70,a:.75},{col:"#e3ba00",lvl:80,a:1},{col:"#fa3600",lvl:90,a:1},{col:"#db0000",lvl:100,a:1}],"total-ozone":[{col:"#6b00f9",lvl:180,a:1},{col:"#3236ff",lvl:200,a:1},{col:"#0c7df7",lvl:220,a:1},{col:"#00bae0",lvl:240,a:1},{col:"#12e5bd",lvl:260,a:.75},{col:"#3cfc8e",lvl:280,a:.5},{col:"#76fc58",lvl:300,a:.75},{col:"#b2e51c",lvl:320,a:.9},{col:"#e3ba00",lvl:340,a:1},{col:"#fd7d00",lvl:360,a:1},{col:"#fa3600",lvl:380,a:1},{col:"#db0000",lvl:400,a:1},{col:"#a70000",lvl:420,a:1}],temperature:[{col:"#00bae0",lvl:5,a:0},{col:"#12e5bd",lvl:10,a:.5},{col:"#3cfc8e",lvl:15,a:.5},{col:"#76fc58",lvl:20,a:.75},{col:"#b2e51c",lvl:25,a:.75},{col:"#e3ba00",lvl:30},{col:"#fd7d00",lvl:35},{col:"#a70000",lvl:40}],"wind-gust":[{col:"#b2e51c",lvl:10,a:0},{col:"#b2e51c",lvl:11,a:.5},{col:"#e3ba00",lvl:15},{col:"#fd7d00",lvl:20},{col:"#fa3600",lvl:30},{col:"#db0000",lvl:40},{col:"#a70000",lvl:50}]};e.getColors=i},function(t,e){"use strict";function n(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];t.unshift("[jsmap]"),console&&console.log.apply(console,t)}e.log=n},function(t,e,n){"use strict";var r=n(7),o=function(){function t(t,e,n){void 0===n&&(n=0),this.frame=t,this.stream=e,this.minlvl=e.colors.minlvl,this.datetime=t.datetime}return t.prototype.idx=function(){return this.frame.idx},t.prototype.points=function(){return this.pointList||this.convert(this.frame,this.minlvl),this.pointList},t.prototype.canvas=function(){if(!this.canvasElt){var t=document.createElement("canvas"),e=this.stream.size.width,n=this.stream.size.height;t.width=e,t.height=n;var r=t.getContext("2d"),o=r.createImageData(e,n),i=this.stream.colors.lut.hex;return this.points().forEach(function(t){var n,r=t.v,a=i[r],s=4*(t.x+t.y*e);n=5>r?8:10>r?9:10,n=25.5*n*(2/3);for(var u=t.n;u>0;u--)o.data[s++]=a>>16&255,o.data[s++]=a>>8&255,o.data[s++]=255&a,o.data[s++]=128}),r.putImageData(o,0,0),t}return this.canvasElt},t.prototype.size=function(){return this.stream.size},t.prototype.bounds=function(){return this.stream.bounds},t.prototype.convert=function(t,e){var n=[],o=this.stream.size.width,i=(new Date).getTime();n=t.datax?r.compactDecoder(t.datax,o,e):"string"==typeof t.data?r.compactDecoder(t.data,o,e):r.matrixDecoder(t.data,e);(new Date).getTime()-i;this.pointList=n},t}();e.Frame=o},function(t,e){"use strict";function n(t,e){var n=[];return t.forEach(function(t,r){for(var o=0,i=0;i<t.length;i++){var a=t.charCodeAt(i),s=0,u=0;if(a>=97)if(u=a-97,t.charCodeAt(i+1)>=65)s=t.charCodeAt(++i)-65;else{for(var c=t[++i];t.charCodeAt(i+1)<=57;)c+=t[++i];s=1*c}else a>=65&&(u=a-65,s=1);u>=e&&n.push({v:u,x:o,y:r,n:s}),o+=s}}),n}function r(t,e,n){for(var r=[],o=0,i=0,a=t.length,s=0;a>s;s++){var u=t.charCodeAt(s),c=0,l=0;if(u>=97)if(l=u-97,t.charCodeAt(s+1)>=65)c=t.charCodeAt(++s)-65;else{for(var f=t[++s];t.charCodeAt(s+1)<=57;)f+=t[++s];c=1*f}else u>=65&&(l=u-65,c=1);for(;o+c>=e;)l>=n&&r.push({v:l,x:o,y:i,n:e-o}),c-=e-o,o=0,i++;c&&l>=n&&r.push({v:l,x:o,y:i,n:c}),o+=c}return r}e.matrixDecoder=n,e.compactDecoder=r},function(t,e,n){(function(e){!function(n){function r(){}function o(t,e){return function(){t.apply(e,arguments)}}function i(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],f(t,this)}function a(t,e){for(;3===t._state;)t=t._value;return 0===t._state?void t._deferreds.push(e):(t._handled=!0,void i._immediateFn(function(){var n=1===t._state?e.onFulfilled:e.onRejected;if(null===n)return void(1===t._state?s:u)(e.promise,t._value);var r;try{r=n(t._value)}catch(o){return void u(e.promise,o)}s(e.promise,r)}))}function s(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof i)return t._state=3,t._value=e,void c(t);if("function"==typeof n)return void f(o(n,e),t)}t._state=1,t._value=e,c(t)}catch(r){u(t,r)}}function u(t,e){t._state=2,t._value=e,c(t)}function c(t){2===t._state&&0===t._deferreds.length&&i._immediateFn(function(){t._handled||i._unhandledRejectionFn(t._value)});for(var e=0,n=t._deferreds.length;n>e;e++)a(t,t._deferreds[e]);t._deferreds=null}function l(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function f(t,e){var n=!1;try{t(function(t){n||(n=!0,s(e,t))},function(t){n||(n=!0,u(e,t))})}catch(r){if(n)return;n=!0,u(e,r)}}var d=setTimeout;i.prototype["catch"]=function(t){return this.then(null,t)},i.prototype.then=function(t,e){var n=new this.constructor(r);return a(this,new l(t,e,n)),n},i.all=function(t){var e=Array.prototype.slice.call(t);return new i(function(t,n){function r(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(t){r(i,t)},n)}e[i]=a,0===--o&&t(e)}catch(u){n(u)}}if(0===e.length)return t([]);for(var o=e.length,i=0;i<e.length;i++)r(i,e[i])})},i.resolve=function(t){return t&&"object"==typeof t&&t.constructor===i?t:new i(function(e){e(t)})},i.reject=function(t){return new i(function(e,n){n(t)})},i.race=function(t){return new i(function(e,n){for(var r=0,o=t.length;o>r;r++)t[r].then(e,n)})},i._immediateFn="function"==typeof e&&function(t){e(t)}||function(t){d(t,0)},i._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)},i._setImmediateFn=function(t){i._immediateFn=t},i._setUnhandledRejectionFn=function(t){i._unhandledRejectionFn=t},"undefined"!=typeof t&&t.exports?t.exports=i:n.Promise||(n.Promise=i)}(this)}).call(e,n(9).setImmediate)},function(t,e,n){(function(t,r){function o(t,e){this._id=t,this._clearFn=e}var i=n(10).nextTick,a=Function.prototype.apply,s=Array.prototype.slice,u={},c=0;e.setTimeout=function(){return new o(a.call(setTimeout,window,arguments),clearTimeout)},e.setInterval=function(){return new o(a.call(setInterval,window,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(t){t.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(window,this._id)},e.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},e.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},e._unrefActive=e.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},e.setImmediate="function"==typeof t?t:function(t){var n=c++,r=arguments.length<2?!1:s.call(arguments,1);return u[n]=!0,i(function(){u[n]&&(r?t.apply(null,r):t.call(null),e.clearImmediate(n))}),n},e.clearImmediate="function"==typeof r?r:function(t){delete u[t]}}).call(e,n(9).setImmediate,n(9).clearImmediate)},function(t,e){function n(){c=!1,a.length?u=a.concat(u):l=-1,u.length&&r()}function r(){if(!c){var t=setTimeout(n);c=!0;for(var e=u.length;e;){for(a=u,u=[];++l<e;)a&&a[l].run();l=-1,e=u.length}a=null,c=!1,clearTimeout(t)}}function o(t,e){this.fun=t,this.array=e}function i(){}var a,s=t.exports={},u=[],c=!1,l=-1;s.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];u.push(new o(t,e)),1!==u.length||c||setTimeout(r,0)},o.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=i,s.addListener=i,s.once=i,s.off=i,s.removeListener=i,s.removeAllListeners=i,s.emit=i,s.binding=function(t){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(t){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}}])});